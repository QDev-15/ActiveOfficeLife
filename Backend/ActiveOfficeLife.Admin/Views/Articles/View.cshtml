@model PostModel
@using ActiveOfficeLife.Common.Models
@using Microsoft.AspNetCore.Http.Extensions

@{
    // Controller provides ViewBag.IdOrSlug and ViewBag.Preview (bool)
    var idOrSlug = ViewBag.IdOrSlug as string ?? "";
    var preview = (ViewBag.Preview as bool?) ?? false;
}
<div id="article-root" data-id-or-slug="@idOrSlug" data-preview="@(preview ? "1" : "0")"></div>

<script type="module">
    import { apiInstance } from '/js/modules/core/api.module.js';
    import { messageInstance } from '/js/modules/core/messages.module.js';
    import { utilities } from '/js/modules/core/utilities.module.js';

    const root = document.getElementById('article-root');

    function renderNotFound(msg = 'Bài viết không tồn tại.') {
        root.innerHTML = `<div class="container py-5"><div class="alert alert-warning">${utilities.escapeHtml(msg)}</div></div>`;
    }

    function buildHtml(post) {
        const title = post.seoMetadata?.metaTitle || post.title || 'Bài viết';
        const summary = post.summary || '';
        const content = post.content || '';
        const created = post.createdAt ? new Date(post.createdAt).toLocaleString() : '';
        const updated = post.updatedAt ? new Date(post.updatedAt).toLocaleString() : '';
        const categoryLink = post.category?.slug ? `/chuyen-muc/${encodeURIComponent(post.category.slug)}` : '#';
        const tagsHtml = (post.tags || []).map(t => `<a class="badge bg-light text-dark me-1 text-decoration-none" href="/tag/${encodeURIComponent(t.slug)}">${utilities.escapeHtml(t.name || '')}</a>`).join('');

        return `
        <div class="container-fluid pt-3">
            <a onclick="history.back()" class="btn btn-outline-secondary mb-3">
                <i class="bi bi-arrow-left me-1"></i>Quay lại
            </a>

            <div class="article-header py-4 mb-3">
                <div class="container">
                    <nav class="small mb-2 text-muted">
                        <a href="/" class="text-muted text-decoration-none">Trang chủ</a>
                        <span class="mx-1">/</span>
                        ${post.category?.name ? `<a href="${categoryLink}" class="text-muted text-decoration-none">${utilities.escapeHtml(post.category.name)}</a><span class="mx-1">/</span>` : ''}
                        <span class="text-muted">Bài viết</span>
                    </nav>

                    <h1 class="h2 mb-2">${utilities.escapeHtml(post.title || '')}</h1>
                    <div class="d-flex flex-wrap gap-3 align-items-center text-muted">
                        ${created ? `<div><i class="bi bi-calendar3 me-1"></i> ${utilities.escapeHtml(created)}</div>` : ''}
                        ${updated ? `<div><i class="bi bi-arrow-repeat me-1"></i> Cập nhật: ${utilities.escapeHtml(updated)}</div>` : ''}
                        <div><i class="bi bi-clock me-1"></i> <span id="readingTime">~3 phút đọc</span></div>
                        ${post.status ? `<span class="badge bg-${({'published':'success','draft':'secondary','paused':'warning','closed':'dark'}[(post.status||'').toLowerCase()]||'secondary')} badge-status">${utilities.escapeHtml(post.status)}</span>` : ''}
                    </div>
                </div>
            </div>

            <div class="container">
                <div id="ad-top" class="ad-slot small mb-3">[ Quảng cáo Top ]</div>
                <div class="row g-4">
                    <div class="col-lg-8">
                        <article class="prose" id="articleContent">${content}</article>
                        <div id="ad-in-article-1" class="ad-slot my-4">[ Quảng cáo In-Article ]</div>
                        ${tagsHtml ? `<div class="mt-4"><strong class="me-2">Tags:</strong>${tagsHtml}</div>` : ''}
                        <hr class="my-4"/>
                        <div class="share d-flex align-items-center gap-2">
                            <span class="text-muted me-1">Chia sẻ:</span>
                            <a id="shareFb" class="btn btn-sm btn-outline-secondary" target="_blank"><i class="bi bi-facebook me-1"></i>Facebook</a>
                            <a id="shareTw" class="btn btn-sm btn-outline-secondary" target="_blank"><i class="bi bi-twitter-x me-1"></i>Twitter</a>
                            <button class="btn btn-sm btn-outline-secondary" id="btnCopyLink"><i class="bi bi-link-45deg me-1"></i>Copy link</button>
                        </div>
                        <div id="ad-bottom" class="ad-slot my-4">[ Quảng cáo Bottom ]</div>
                    </div>

                    <div class="col-lg-4">
                        <div class="sticky-side">
                            <div id="ad-sidebar" class="ad-slot mb-3" style="min-height: 600px;">[ Quảng cáo Sidebar ]</div>
                            <div class="card">
                                <div class="card-header bg-white fw-semibold">Có thể bạn quan tâm</div>
                                <ul class="list-group list-group-flush small">
                                    <li class="list-group-item d-flex"><i class="bi bi-chevron-right me-2"></i><a class="text-decoration-none" href="#">Mẹo chăm sóc sức khỏe mùa mưa</a></li>
                                    <li class="list-group-item d-flex"><i class="bi bi-chevron-right me-2"></i><a class="text-decoration-none" href="#">5 thực phẩm nên ăn mỗi tuần</a></li>
                                    <li class="list-group-item d-flex"><i class="bi bi-chevron-right me-2"></i><a class="text-decoration-none" href="#">Tập thở đúng giúp ngủ ngon</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    }

    (async function () {
        // Determine idOrSlug (server may pass it via data- attribute)
        let idOrSlug = root.dataset.idOrSlug || '';
        const previewFlag = root.dataset.preview === '1';

        if (!idOrSlug) {
            // try parse from path /Articles/View/{idOrSlug}
            const m = location.pathname.match(/\/Articles\/View\/(.+)$/i);
            if (m && m[1]) idOrSlug = decodeURIComponent(m[1]);
            else idOrSlug = new URLSearchParams(location.search).get('id') || '';
        }

        if (!idOrSlug) {
            renderNotFound('Không tìm thấy bài viết.');
            return;
        }

        const isGuid = /^[0-9a-fA-F\-]{36}$/.test(idOrSlug);
        const endpoint = isGuid ? `/post/get/${encodeURIComponent(idOrSlug)}` : `/post/get-by-slug/${encodeURIComponent(idOrSlug)}`;

        try {
            const post = await apiInstance.get(endpoint);
            if (!post) { renderNotFound(); return; }

            // check publish status
            const status = (post.status || '').toLowerCase();
            const isPublished = status === 'published';
            if (!isPublished && !previewFlag) {
                renderNotFound('Bài viết chưa được xuất bản.');
                return;
            }

            // render UI
            root.innerHTML = buildHtml(post);

            // update title and meta
            const newTitle = post.seoMetadata?.metaTitle || post.title || document.title;
            document.title = newTitle;
            const desc = post.seoMetadata?.metaDescription || post.summary || '';
            const kw = post.seoMetadata?.metaKeywords || '';
            // update or create meta tags
            let mDesc = document.querySelector('meta[name="description"]');
            if (!mDesc) { mDesc = document.createElement('meta'); mDesc.name = 'description'; document.head.appendChild(mDesc); }
            mDesc.content = desc;
            let mKw = document.querySelector('meta[name="keywords"]');
            if (!mKw) { mKw = document.createElement('meta'); mKw.name = 'keywords'; document.head.appendChild(mKw); }
            mKw.content = kw;
            // canonical
            let canon = document.querySelector('link[rel="canonical"]');
            if (!canon) { canon = document.createElement('link'); canon.rel = 'canonical'; document.head.appendChild(canon); }
            canon.href = `/bai-viet/${post.slug || post.id}`;

            // reading time
            (function computeReadingTime(){
                const contentEl = document.getElementById('articleContent');
                const html = contentEl?.innerText || '';
                const words = (html.trim().match(/\S+/g) || []).length;
                const minutes = Math.max(1, Math.round(words / 200));
                const el = document.getElementById('readingTime');
                if (el) el.textContent = `~${minutes} phút đọc`;
            })();

            // share links & copy
            const pageUrl = window.location.href;
            const shareFb = document.getElementById('shareFb');
            const shareTw = document.getElementById('shareTw');
            if (shareFb) shareFb.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}`;
            if (shareTw) shareTw.href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(pageUrl)}&text=${encodeURIComponent(post.title || '')}`;
            document.getElementById('btnCopyLink')?.addEventListener('click', async () => {
                try { await navigator.clipboard.writeText(window.location.href); } catch {}
            });

            // place in-article ad after paragraph 2
            (function placeInArticleAd(){
                const content = document.getElementById('articleContent');
                const ad = document.getElementById('ad-in-article-1');
                if (!content || !ad) return;
                const ps = content.querySelectorAll('p');
                if (ps.length >= 2) ps[1].insertAdjacentElement('afterend', ad);
            })();

        } catch (err) {
            console.error(err);
            messageInstance.error('Lỗi tải bài viết.');
        }
    })();
</script>
